<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Submit a Support Ticket</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --g-900:#0f3d15; --g-800:#1b5e20; --g-700:#2e7d32; --g-500:#43a047;
      --g-300:#81c784; --g-200:#c8e6c9; --g-100:#e8f5e9; --g-050:#f9fdf9;
    }
    *{box-sizing:border-box}
    body {
      font-family: Montserrat, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding: 20px; max-width: 760px; margin: 0 auto;
      background: var(--g-050); color: #1a1a1a;
    }
    h1 { color: var(--g-800); margin-bottom: .4em; }
    p.intro { margin: 0 0 1.25em; color: var(--g-700); line-height: 1.5; }
    label { display:block; margin: 12px 0 6px; font-weight: 600; color: var(--g-800); }
    select, button, textarea, input[type="text"], input[type="url"], input[type="date"], input[type="datetime-local"] {
      width: 100%; padding: 10px; font-size: 15px; border-radius: 8px;
      border: 1px solid var(--g-200); background:#fff;
    }
    select:focus, button:focus, textarea:focus, input:focus { outline: 2px solid var(--g-500); outline-offset: 1px; }
    select[disabled], textarea[disabled], input[disabled] { background: #f3f7f3; color:#6b6b6b; }
    .row { display:flex; gap:12px; margin-top:12px; }
    .row > * { flex:1; min-width: 180px; }
    button.primary {
      background: var(--g-700); color: #fff; border: none; font-weight: 700; cursor: pointer;
      transition: background .18s;
    }
    button.primary:hover { background: var(--g-800); }
    button.ghost {
      background: #fff; color: var(--g-800); border: 1px solid var(--g-300); font-weight: 600; cursor: pointer;
    }
    button[disabled] { opacity:.6; cursor: not-allowed; }
    .note { font-size: 13px; color: var(--g-700); margin-top: 6px; }

    /* Info + error + success panels */
    .status {
      margin-top: 10px; padding: 10px; border-radius: 8px; border:1px solid var(--g-200); background: var(--g-100);
      color: var(--g-800); font-size: 14px; display:none; white-space:pre-wrap;
    }
    .status.error { border-color:#f2b8b5; background:#fdecea; color:#b3261e; }
    .success {
      margin-top: 14px; padding: 12px; border-radius: 10px;
      border:1px solid #a5d6a7; background:#e8f5e9; color:#1b5e20; display:none;
    }
    .success strong { display:block; margin-bottom: 6px; }

    /* Webhook response blocks (visible to any submitter) */
    .resp-wrap { margin-top: 14px; display:none; }
    .resp-wrap h3 { margin: 0 0 6px; font-size: 16px; color: var(--g-800); }
    pre#respRaw {
      margin:0; background: #fff; padding:12px; border-radius:8px;
      border:1px solid var(--g-200); white-space:pre-wrap; max-height: 360px; overflow:auto;
    }
    .resp-pretty { margin-top: 10px; }

    .section { margin-top: 18px; padding-top: 6px; border-top: 1px dashed var(--g-200); }
    .muted { color:#517a53; font-size:13px; margin-top:6px; }

    /* Popover select */
    .select-anchor { position: relative; }
    .pop-wrap {
      position: absolute;
      z-index: 9999;
      width: var(--pop-width, 100%);
      background:#fff;
      border:1px solid var(--g-200);
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
      overflow: hidden;
    }
    .pop-search { width:100%; border:none; border-bottom:1px solid var(--g-200); padding:10px 12px; font-size:14px; outline:none; }
    .pop-list { max-height: 260px; overflow:auto; padding:6px 0; }
    .pop-item {
      padding:8px 12px; cursor:pointer; font-size:14px; line-height:1.3;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pop-item:hover, .pop-item[aria-selected="true"] { background: var(--g-100); }

    /* RTE */
    .rte-toolbar { display:flex; gap:6px; margin:6px 0 8px; flex-wrap: wrap; }
    .rte-toolbar button {
      display:inline-block; width:auto; min-width:34px; padding:4px 8px;
      border:1px solid var(--g-300); border-radius:6px; background:#fff; cursor:pointer; font-size:14px; line-height:1.2;
    }
    .rte-toolbar button:hover { background: var(--g-100); }
    .rte-toolbar button[aria-pressed="true"]{ background: var(--g-100); }
    .rte-box {
      min-height: 160px; padding:10px; border:1px solid var(--g-200); border-radius:8px; background:#fff;
    }
    .rte-box:focus { outline: 2px solid var(--g-500); }
    .rte-box:empty:before { content: attr(data-placeholder); color: #7aa07b; }
    .rte-box a { text-decoration: underline; color: var(--g-700); }

    /* Attachments */
    .dropzone {
      border: 2px dashed var(--g-300);
      border-radius: 10px; background: #fff; padding: 16px; text-align: center;
      color: #517a53; cursor: pointer; user-select: none;
    }
    .dropzone.dragover { background: var(--g-100); border-color: var(--g-500); }
    .img-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap: 10px; margin-top:10px; }
    .img-card { border:1px solid var(--g-200); border-radius:10px; overflow:hidden; background:#fff; position:relative; }
    .img-card img { width:100%; height:110px; object-fit:cover; display:block; cursor:pointer; }
    .img-remove {
      position:absolute; top:6px; right:6px; background:#fff; border:1px solid var(--g-300);
      border-radius:8px; padding:2px 8px; font-size:12px; cursor:pointer;
    }
    .img-modal { position: fixed; inset: 0; background: rgba(0,0,0,.5); display:none; align-items: center; justify-content: center; z-index: 10000; }
    .img-panel { background: #fff; border-radius: 12px; padding: 14px; max-width: 960px; width: calc(100% - 32px); max-height: 85vh; overflow: auto; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .modal-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .modal-top button { border:1px solid var(--g-300); background:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; }
    .img-viewer { display:flex; justify-content:center; margin-bottom:12px; }
    .img-viewer img { max-width:100%; max-height:60vh; border-radius:10px; }
  </style>
</head>
<body>
  <h1>Submit a Support Ticket</h1>
  <p class="intro">
    Fill out the form below. Your ticket will be created in ClickUp. After submit, everyone sees the exact webhook response here, including the task link.
  </p>

  <form id="form" novalidate>
    <label for="submitter">Who is submitting this ticket? *</label>
    <div class="select-anchor">
      <select id="submitter" name="submitter" required disabled data-searchable>
        <option value="" selected>Click “Fetch new data” to load submitters…</option>
      </select>
    </div>

    <div class="section">
      <label for="team">Which team is this for? *</label>
      <div class="select-anchor">
        <select id="team" name="team" required data-searchable>
          <option value="" selected>Select a team…</option>
          <option>Ads</option>
          <option>Client Team</option>
          <option>Operations</option>
          <option>Sales & Marketing</option>
          <option>SEO</option>
          <option>Bilingual SEO</option>
          <option>Content</option>
          <option>Web</option>
        </select>
      </div>
    </div>

    <div class="section">
      <label for="client">Which client is this for? *</label>
      <div class="select-anchor">
        <select id="client" name="client" required disabled data-searchable>
          <option value="" selected>Click “Fetch new data” to load clients…</option>
        </select>
      </div>
    </div>

    <div class="section">
      <label for="clientUrl">Client Website</label>
      <input id="clientUrl" type="url" placeholder="Auto-filled after you choose a client…" disabled readonly />
      <div class="muted" id="clientUrlLinkWrap" style="display:none;">
        <a id="clientUrlLink" href="#" target="_blank" rel="noopener">Open website</a>
      </div>
    </div>

    <div class="section">
      <label for="template">What type of ticket is this? *</label>
      <div class="select-anchor">
        <select id="template" name="template" required disabled data-searchable>
          <option value="" selected>Click “Fetch new data” to load templates…</option>
        </select>
      </div>
      <div class="muted">Selecting a template will auto-fill the description and due date/time.</div>
    </div>

    <div class="section">
      <label for="dueDate">Due Date & Time</label>
      <input id="dueDate" type="datetime-local" />
      <div class="muted">Absolute (YYYY-MM-DD HH:MM) or relative like +8h, 2d 4h 30m.</div>
    </div>

    <!-- DESCRIPTION with RTE -->
    <div class="section">
      <label for="description">Description</label>

      <!-- RTE: toolbar -->
      <div class="rte-toolbar" id="rteToolbar">
        <button type="button" data-cmd="bold"><strong>B</strong></button>
        <button type="button" data-cmd="italic"><em>I</em></button>
        <button type="button" data-cmd="underline"><u>U</u></button>
        <button type="button" data-cmd="insertUnorderedList">• Bullets</button>
        <button type="button" data-cmd="insertOrderedList">1. Numbers</button>
        <button type="button" data-cmd="formatBlock" data-value="H3">H3</button>
        <button type="button" data-cmd="formatBlock" data-value="BLOCKQUOTE">Quote</button>
        <button type="button" data-action="code">Code</button>
        <button type="button" data-action="link">Link</button>
        <button type="button" data-action="clear">Clear</button>
      </div>

      <!-- RTE: contenteditable box -->
      <div id="descriptionEditor" class="rte-box" contenteditable="true" data-placeholder="Template description will appear here after you choose a template…"></div>

      <!-- Hidden textarea that gets the HTML for submit -->
      <textarea id="description" name="description" style="display:none;"></textarea>

      <div class="muted">Format: bold, italic, underline, bullets, numbers, quotes, code, links. Images belong in Attachments below.</div>
    </div>

    <!-- Attachments -->
    <div class="section">
      <label>Attachments</label>
      <div id="dropzone" class="dropzone" tabindex="0">
        Click to upload, or drag & drop / paste images here
      </div>
      <div class="img-grid" id="attachGrid"></div>
      <input type="file" id="fileImageInput" accept="image/*" multiple style="display:none" />
      <div class="row">
        <button type="button" id="btnUploadImage" class="ghost">Upload Image</button>
        <button type="button" id="btnViewAttachments" class="ghost">View Images</button>
      </div>
      <div class="muted">Images are stored as separate attachments (not inside the description).</div>
    </div>

    <div class="row">
      <button type="button" id="btnFetch" class="ghost">Fetch new data</button>
      <button type="submit" class="primary" id="btnSubmit" disabled>Submit Ticket</button>
    </div>

    <div id="status" class="status"></div>
    <div id="success" class="success" role="status" aria-live="polite"></div>
    <div class="note">If your n8n workflow is OFF, use /webhook-test/ endpoints.</div>
  </form>

  <!-- Webhook response (visible to any submitter) -->
  <div class="resp-wrap" id="respWrap">
    <h3>Webhook response</h3>
    <pre id="respRaw"></pre>
    <div id="respPretty" class="status resp-pretty"></div>
  </div>

  <!-- Image gallery modal -->
  <div id="imgModal" class="img-modal" aria-hidden="true">
    <div class="img-panel" role="dialog" aria-modal="true" aria-label="Images in attachments">
      <div class="modal-top">
        <strong>Images in Attachments</strong>
        <button type="button" id="btnCloseModal">Close</button>
      </div>
      <div class="img-viewer" id="imgViewer"></div>
      <div id="imgGridModal" class="img-grid"></div>
    </div>
  </div>

  <script>
    // Endpoints (switch to /webhook-test/... if the n8n workflow is OFF)
    const CHOICES_URL        = "https://n8n-14lp.onrender.com/webhook/ticket-choices"; // GET
    const TICKET_WEBHOOK_URL = "https://n8n-14lp.onrender.com/webhook/ticker-maker";   // POST

    // ---------- HELPERS ----------
    const $ = s => document.querySelector(s);
    const byId = id => document.getElementById(id);

    function show(el){ el.style.display = "block"; }
    function hide(el){ el.style.display = "none"; }

    function escapeHtml(str){
      return String(str)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }
    function linkify(str){
      return String(str).replace(/(https?:\/\/[^\s"']+)/g, (m) =>
        `<a href="${m}" target="_blank" rel="noopener">${m}</a>`
      );
    }

    function renderPrettyResponse(bodyText, statusCode){
      const box = byId("respPretty");
      let html = `<strong>Response ${statusCode}</strong>`;
      try{
        const obj = JSON.parse(bodyText);
        const rows = Object.entries(obj).map(([k,v]) => {
          const value = typeof v === "string" ? linkify(escapeHtml(v)) : escapeHtml(JSON.stringify(v, null, 2));
          return `<li><strong>${escapeHtml(k)}:</strong> ${value}</li>`;
        }).join("");
        html += `<ul>${rows}</ul>`;
      }catch(_){
        html += `<pre style="white-space:pre-wrap;margin:6px 0 0;">${linkify(escapeHtml(bodyText))}</pre>`;
      }
      box.innerHTML = html;
      show(box);
      show(byId("respWrap"));
    }

    function setStatus(text, isError=false){
      const el = byId("status");
      if(!text){ hide(el); el.textContent=""; el.classList.remove("error"); return; }
      el.textContent = text;
      el.classList.toggle("error", !!isError);
      show(el);
    }

    function setSuccess(objOrText){
  const el = byId("success");

  // Helper to html-escape & linkify
  const esc = s => escapeHtml(String(s ?? ''));
  const aTag = (href, text) => `<a href="${esc(href)}" target="_blank" rel="noopener">${esc(text || href)}</a>`;

  let heading = "Task created successfully.";
  let detailsHtml = "";

  if (typeof objOrText === "string") {
    // Plain text: show it as the heading
    heading = objOrText.trim() ? esc(objOrText) : heading;
  } else if (objOrText && typeof objOrText === "object") {
    // Optional custom message from webhook
    if (objOrText.message || objOrText.msg) heading = esc(objOrText.message || objOrText.msg);

    // Normalize common fields from various webhook shapes
    const assignee = objOrText.assignee || objOrText.assigned_to || objOrText.owner || "";
    const client   = objOrText.client || objOrText.clientName || objOrText.workspace || "";
    const taskType = objOrText.taskType || objOrText.templateName || objOrText.type || "";
    const taskId   = objOrText.taskId || objOrText.id || objOrText.task_id || "";
    const link     = objOrText.link || objOrText.taskUrl || objOrText.url || objOrText.permalink || "";

    // Build bullet list only for fields that exist
    const rows = [];
    if (assignee) rows.push(`<li><strong>assignee:</strong> ${esc(assignee)}</li>`);
    if (client)   rows.push(`<li><strong>client:</strong> ${esc(client)}</li>`);
    if (taskType) rows.push(`<li><strong>taskType:</strong> ${esc(taskType)}</li>`);
    if (link)     rows.push(`<li><strong>link:</strong> ${aTag(link)}</li>`);
    if (taskId && !link) rows.push(`<li><strong>taskId:</strong> <code>${esc(taskId)}</code></li>`);

    // If none of the common keys exist, show a compact key/value dump (strings only)
    if (rows.length === 0) {
      const entries = Object.entries(objOrText)
        .filter(([_, v]) => typeof v === "string" || typeof v === "number")
        .slice(0, 10) // keep it short
        .map(([k, v]) => {
          const val = String(v);
          // turn URLs into links
          return /https?:\/\/\S+/i.test(val)
            ? `<li><strong>${esc(k)}:</strong> ${aTag(val)}</li>`
            : `<li><strong>${esc(k)}:</strong> ${esc(val)}</li>`;
        });
      if (entries.length) rows.push(...entries);
    }

    if (rows.length) {
      detailsHtml = `<ul style="margin:8px 0 0; padding-left:18px;">${rows.join("")}</ul>`;
    }
  }

  el.innerHTML = `<strong>${heading}</strong>${detailsHtml}`;
  show(el);
}

    function enableForm(enabled){
      byId("submitter").disabled = !enabled;
      byId("client").disabled = !enabled;
      byId("template").disabled = !enabled;
      byId("btnSubmit").disabled = !enabled;
      byId("dueDate").disabled = !enabled ? true : false;
      byId("clientUrl").disabled = !enabled;
    }

    function option(valObj, labelText){
      const opt = document.createElement("option");
      opt.value = JSON.stringify(valObj);
      opt.textContent = labelText;
      return opt;
    }

    // ---------- SELECT FILL ----------
    function fillSubmitter(items){
      const el = byId("submitter");
      el.innerHTML = "";
      el.appendChild(new Option("Select a submitter…","",true,true));
      (items || []).forEach(item => {
        el.appendChild(option(
          { id: String(item.value || ""), name: String(item.label || "") },
          item.label || ""
        ));
      });
      enhanceSelect(el);
    }

    function fillClient(items){
      const el = byId("client");
      el.innerHTML = "";
      el.appendChild(new Option("Select a client…","",true,true));
      (items || []).forEach(item => {
        el.appendChild(option(
          {
            name:     String(item.label || item["Matching True Name"] || ""),
            listId:   String(item.value || item.listId || item["List ID"] || ""),
            folderId: String(item.folderId || item["Folder ID"] || ""),
            ticketId: String(item.ticketId || item["Ticket ID"] || ""),
            url:      String(item.url || item.URL || item["URL"] || item.website || item.Website || item.link || item.Link || "")
          },
          item.label || item["Matching True Name"] || ""
        ));
      });
      enhanceSelect(el);
      updateClientWebsiteFromSelect();
    }

    function fillTemplates(items){
      const el = byId("template");
      el.innerHTML = "";
      el.appendChild(new Option("Select a template…","",true,true));
      (items || []).forEach(item => {
        el.appendChild(option(
          {
            id:   String(item.value || item.id || item["ID"] || ""),
            name: String(item.label || item.name || item["Matched Template Name"] || ""),
            data: String(item.data  || item["Data"] || ""),
            due:  String(item.due   || item.dueDates || item["Due Dates"] || item["Due Date"] || "")
          },
          item.label || item.name || item["Matched Template Name"] || ""
        ));
      });
      enhanceSelect(el);
      handleTemplateChange();
    }

    function dedupeBy(arr, keyFn){
      const seen = new Set();
      return (arr || []).filter(x => {
        const k = keyFn(x);
        if(!k || seen.has(k)) return false;
        seen.add(k);
        return true;
      });
    }

    // ---------- RTE CORE ----------
    const editor = byId("descriptionEditor");
    const toolbar = byId("rteToolbar");

    // allow tags + normalize headings to <p><b>..</b></p> so nothing is lost
    const ALLOWED_TAGS = new Set([
      "P","BR","STRONG","B","EM","I","U","UL","OL","LI","A",
      "H1","H2","H3","H4","H5","H6","BLOCKQUOTE","PRE","CODE"
    ]);
    const ALLOWED_ATTRS = { A: new Set(["href","target","rel"]) };

    function sanitizeUrl(u){
      try{ const url=new URL(u); if(/^https?:$/.test(url.protocol)) return url.toString(); }catch(_){}
      return "";
    }

    function sanitizeHtml(html){
      const tpl = document.createElement("template");
      tpl.innerHTML = html;
      (function walk(node){
        const children = Array.from(node.childNodes);
        for(const n of children){
          if(n.nodeType === 1){
            if(!ALLOWED_TAGS.has(n.tagName)){
              while(n.firstChild) node.insertBefore(n.firstChild, n);
              node.removeChild(n);
              continue;
            }
            [...n.attributes].forEach(a => {
              const ok = (ALLOWED_ATTRS[n.tagName] && ALLOWED_ATTRS[n.tagName].has(a.name.toLowerCase()));
              if(!ok) n.removeAttribute(a.name);
            });
            if(n.tagName === "A"){
              const clean = sanitizeUrl(n.getAttribute("href") || "");
              if(!clean){ n.replaceWith(...n.childNodes); continue; }
              n.setAttribute("href", clean);
              n.setAttribute("target","_blank");
              n.setAttribute("rel","noopener");
            }
            walk(n);
          }else if(n.nodeType === 8){
            node.removeChild(n);
          }
        }
      })(tpl.content);

      // wrap bare text into <p>
      (function wrapOrphanText(root){
        const frag = document.createDocumentFragment();
        root.childNodes.forEach(ch=>{
          if(ch.nodeType===3 && ch.nodeValue.trim()){
            const p = document.createElement("p"); p.textContent = ch.nodeValue; frag.appendChild(p);
          }else{
            frag.appendChild(ch);
          }
        });
        root.replaceChildren(frag);
      })(tpl.content);

      // normalize headings → <p><b>…</b></p>
      tpl.content.querySelectorAll('h1,h2,h3,h4,h5,h6').forEach(h => {
        const p = document.createElement('p');
        const b = document.createElement('b');
        b.textContent = h.textContent;
        p.appendChild(b);
        h.replaceWith(p);
      });

      return tpl.innerHTML;
    }

    // Enter key: Shift+Enter => <br>, Enter => new paragraph
    editor.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        if(e.shiftKey){
          document.execCommand("insertLineBreak");
          return;
        }
        const sel = window.getSelection();
        if(!sel || !sel.rangeCount) return;
        const range = sel.getRangeAt(0);
        const p = document.createElement("p");
        p.innerHTML = "<br>";
        range.collapse(false);
        range.insertNode(p);
        const newRange = document.createRange();
        newRange.setStart(p, 0);
        newRange.collapse(true);
        sel.removeAllRanges();
        sel.addRange(newRange);
      }
    });

    function insertHtmlAtCursor(html){
      editor.focus();
      if(document.queryCommandSupported && document.queryCommandSupported("insertHTML")){
        document.execCommand("insertHTML", false, html);
      }else{
        const sel = window.getSelection();
        if(!sel || !sel.rangeCount) return;
        const range = sel.getRangeAt(0);
        range.deleteContents();
        const frag = range.createContextualFragment(html);
        range.insertNode(frag);
        range.collapse(false);
      }
    }

    toolbar.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const cmd = btn.dataset.cmd;
      const val = btn.dataset.value || null;
      const action = btn.dataset.action;

      editor.focus();

      if(cmd){
        if(cmd === "formatBlock" && val){
          // Chromium prefers angle-bracket form
          const tag = val === "H3" ? "<h3>" : val;
          document.execCommand("formatBlock", false, tag);
        }else{
          document.execCommand(cmd, false, val);
        }
        return;
      }
      if(action === "link"){
        const href = prompt("Enter URL to link:", "https://");
        const clean = sanitizeUrl(href || "");
        if(!clean) return;
        document.execCommand("createLink", false, clean);
        const sel = window.getSelection();
        if(sel && sel.anchorNode){
          const a = (sel.anchorNode.parentElement && sel.anchorNode.parentElement.closest("a"));
          if(a){ a.setAttribute("target","_blank"); a.setAttribute("rel","noopener"); }
        }
        return;
      }
      if(action === "code"){
        document.execCommand("formatBlock", false, "PRE");
        const pre = editor.querySelector("pre");
        if(pre && !pre.querySelector("code")){
          const c = document.createElement("code");
          c.innerHTML = pre.innerHTML;
          pre.replaceChildren(c);
        }
        return;
      }
      if(action === "clear"){
        const plain = editor.textContent || "";
        editor.innerHTML = sanitizeHtml(plain ? `<p>${escapeHtml(plain).replace(/\n+/g,"</p><p>")}</p>` : "");
        return;
      }
    });

    // sanitize pasted content
    editor.addEventListener("paste", (e)=>{
      e.preventDefault();
      const html = e.clipboardData.getData("text/html");
      const text = e.clipboardData.getData("text/plain");
      const safe = sanitizeHtml(html || (text ? `<p>${escapeHtml(text).replace(/\n+/g,"</p><p>")}</p>` : ""));
      insertHtmlAtCursor(safe);
    });

    // ---------- Attachments ----------
    const attachments = []; // {name, type, size, dataUrl}

    function addAttachmentFile(file){
      if(!file || !file.type.startsWith("image/")) return;
      const reader = new FileReader();
      reader.onload = () => {
        attachments.push({ name:file.name, type:file.type, size:file.size, dataUrl:reader.result });
        renderAttachmentsGrid();
      };
      reader.readAsDataURL(file);
    }

    function renderAttachmentsGrid(){
      const grid = byId("attachGrid");
      grid.innerHTML = "";
      attachments.forEach((a, idx) => {
        const card = document.createElement("div");
        card.className = "img-card";
        const img = document.createElement("img");
        img.src = a.dataUrl;
        img.alt = a.name || "attachment";
        img.addEventListener("click", () => openAttachmentGallery(idx));
        const remove = document.createElement("button");
        remove.className = "img-remove";
        remove.type = "button";
        remove.textContent = "Remove";
        remove.addEventListener("click", (e) => {
          e.stopPropagation();
          attachments.splice(idx,1);
          renderAttachmentsGrid();
        });
        card.appendChild(img);
        card.appendChild(remove);
        grid.appendChild(card);
      });
    }

    const dropzone = byId("dropzone");
    dropzone.addEventListener("click", () => byId("fileImageInput").click());
    dropzone.addEventListener("dragover", (e) => { e.preventDefault(); dropzone.classList.add("dragover"); });
    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      const files = Array.from(e.dataTransfer.files || []);
      files.forEach(addAttachmentFile);
    });
    dropzone.addEventListener("paste", (e) => {
      const dt = e.clipboardData;
      if(!dt) return;
      const fileItem = Array.from(dt.items || []).find(i => i.kind === "file" && i.type.startsWith("image/"));
      if(fileItem){
        e.preventDefault();
        addAttachmentFile(fileItem.getAsFile());
      }
    });
    byId("fileImageInput").addEventListener("change", (e) => {
      const files = Array.from(e.target.files || []);
      files.forEach(addAttachmentFile);
      e.target.value = ""; // reset
    });
    byId("btnUploadImage").addEventListener("click", () => byId("fileImageInput").click());
    byId("btnViewAttachments").addEventListener("click", () => openAttachmentGallery(0));

    // ---------- Client Website ----------
    function setClientWebsite(url){
      const input = byId("clientUrl");
      const wrap = byId("clientUrlLinkWrap");
      const link = byId("clientUrlLink");
      input.value = url || "";
      if(url){ show(wrap); link.href = url; }
      else   { hide(wrap); }
    }
    function updateClientWebsiteFromSelect(){
      const raw = byId("client").value;
      if(!raw){ setClientWebsite(""); return; }
      try{ const c = JSON.parse(raw); setClientWebsite(c.url || ""); }catch(_){ setClientWebsite(""); }
    }

    // ---------- Due Date parsing ----------
    function two(n){ return String(n).padStart(2,"0"); }
    function toLocalDatetimeValue(date){
      const d = new Date(date.getTime() - date.getTimezoneOffset()*60000);
      return `${d.getUTCFullYear()}-${two(d.getUTCMonth()+1)}-${two(d.getUTCDate())}T${two(d.getUTCHours())}:${two(d.getUTCMinutes())}`;
    }
    function parseRelativeSpec(s){
      const m = s.trim().match(/^(?:in\s*)?([+-]?\d[\d\s\w:+-]*)$/i);
      if(!m) return null;
      const partRe = /([+-]?\d+)\s*(w|week|weeks|d|day|days|h|hr|hrs|hour|hours|m|min|mins|minute|minutes)/gi;
      let totalMinutes = 0, found = false, p;
      while((p = partRe.exec(s)) !== null){
        found = true;
        const val = parseInt(p[1],10);
        const unit = p[2].toLowerCase();
        let mult = 1;
        if(unit.startsWith("w")) mult = 7*24*60;
        else if(unit.startsWith("d")) mult = 24*60;
        else if(unit.startsWith("h")) mult = 60;
        else mult = 1;
        totalMinutes += val * mult;
      }
      if(!found){
        const bare = s.trim().match(/^([+-]?\d+)$/);
        if(!bare) return null;
        totalMinutes = parseInt(bare[1],10) * 60;
      }
      return new Date(Date.now() + totalMinutes*60000);
    }
    function setAutoDueDate(spec){
      const input = byId("dueDate");
      if(!spec){ input.value = ""; return; }
      const s = String(spec).trim();

      const absMatch = s.match(/^(\d{4}-\d{2}-\d{2})(?:[ T](\d{2}):?(\d{2}))?$/);
      if(absMatch){
        const [_, d, hh="00", mm="00"] = absMatch;
        input.value = `${d}T${hh}:${mm}`;
        return;
      }
      const native = new Date(s);
      if(!isNaN(native.getTime())){
        input.value = toLocalDatetimeValue(native);
        return;
      }
      const rel = parseRelativeSpec(s);
      if(rel){
        input.value = toLocalDatetimeValue(rel);
        return;
      }
      input.value = "";
    }

    // ---------- SEARCHABLE POPOVER ----------
    function normalizeText(s){
      return String(s || "").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "");
    }
    function enhanceSelect(selectEl){
      if(selectEl.dataset.enhanced) return;
      selectEl.dataset.enhanced = "1";
      const anchor = selectEl.closest(".select-anchor") || selectEl.parentElement;
      anchor.style.position = "relative";

      let pop = null, search = null, list = null;
      let items = [];

      function buildItems(){
        const opts = Array.from(selectEl.options);
        items = opts.slice(1).map(o => ({ label: o.textContent || "", value: o.value }));
      }
      function openPopover(){
        closePopover();
        buildItems();
        pop = document.createElement("div");
        pop.className = "pop-wrap";
        pop.style.setProperty('--pop-width', `${selectEl.offsetWidth}px`);
        pop.style.top = (selectEl.offsetHeight + 6) + "px";
        pop.style.left = "0";
        search = document.createElement("input");
        search.type = "text"; search.className = "pop-search"; search.placeholder = "Type to search…";
        list = document.createElement("div"); list.className = "pop-list";
        pop.appendChild(search); pop.appendChild(list); anchor.appendChild(pop);
        renderList(items);
        search.focus();
        search.addEventListener("input", handleFilter);
        search.addEventListener("keydown", handleKeys);
        list.addEventListener("click", handleClick);
        document.addEventListener("mousedown", outsideClose, true);
        window.addEventListener("resize", closePopover);
      }
      function closePopover(){
        if(pop){ document.removeEventListener("mousedown", outsideClose, true); window.removeEventListener("resize", closePopover); pop.remove(); }
        pop = search = list = null;
      }
      function outsideClose(e){ if(pop && !pop.contains(e.target) && e.target !== selectEl) closePopover(); }
      function handleClick(e){
        const item = e.target.closest(".pop-item"); if(!item) return;
        selectEl.value = item.dataset.value;
        selectEl.dispatchEvent(new Event("change", {bubbles:true}));
        closePopover(); selectEl.focus();
      }
      function handleKeys(e){
        const focusable = Array.from(list.querySelectorAll(".pop-item"));
        const current = list.querySelector('.pop-item[aria-selected="true"]');
        let idx = current ? focusable.indexOf(current) : -1;
        if(e.key === "ArrowDown"){ e.preventDefault(); idx = Math.min(idx + 1, focusable.length - 1); setActive(focusable[idx]); }
        else if(e.key === "ArrowUp"){ e.preventDefault(); idx = Math.max(idx - 1, 0); setActive(focusable[idx]); }
        else if(e.key === "Enter"){ e.preventDefault(); if(current){ selectEl.value = current.dataset.value; selectEl.dispatchEvent(new Event("change", {bubbles:true})); closePopover(); selectEl.focus(); } }
        else if(e.key === "Escape"){ e.preventDefault(); closePopover(); selectEl.focus(); }
      }
      function setActive(el){ list.querySelectorAll(".pop-item[aria-selected]").forEach(x => x.removeAttribute("aria-selected")); if(el){ el.setAttribute("aria-selected","true"); el.scrollIntoView({block:"nearest"}); } }
      function handleFilter(){ const q = normalizeText(search.value); const filtered = q ? items.filter(i => normalizeText(i.label).includes(q)) : items.slice(); renderList(filtered); }
      function renderList(arr){
        list.innerHTML = "";
        if(arr.length === 0){ const empty = document.createElement("div"); empty.className="pop-item"; empty.style.cursor="default"; empty.textContent="No matches"; list.appendChild(empty); return; }
        arr.forEach((it,i) => { const div = document.createElement("div"); div.className="pop-item"; div.textContent=it.label; div.dataset.value=it.value; if(i===0) div.setAttribute("aria-selected","true"); list.appendChild(div); });
      }
      selectEl.addEventListener("mousedown", (e) => { if(selectEl.disabled) return; e.preventDefault(); if(pop) closePopover(); else openPopover(); });
      selectEl.addEventListener("keydown", (e) => { if(selectEl.disabled) return; if(e.key==="ArrowDown"||e.key==="Enter"||e.key===" "){ e.preventDefault(); if(!pop) openPopover(); } });
    }

    // ---------- FETCH CHOICES ----------
    async function fetchChoices(){
      // If your workflow is OFF, point CHOICES_URL to /webhook-test/...
      const url = CHOICES_URL + "?t=" + Date.now();
      let res, text;
      try {
        res = await fetch(url, { method:"GET", cache:"no-store" });
      } catch (netErr) {
        throw new Error("Network error or CORS. " + String(netErr));
      }
      try {
        text = await res.text();
      } catch {
        throw new Error(`HTTP ${res?.status || "?"} - failed reading response body.`);
      }
      if (!res.ok) throw new Error(`HTTP ${res.status} from CHOICES_URL.\nBody:\n${text}`);
      let data;
      try { data = JSON.parse(text); }
      catch { throw new Error(`Invalid JSON from CHOICES_URL.\nBody was:\n${text}`); }
      return data;
    }

    async function handleFetchNew(){
      try{
        setStatus("Fetching latest data…");
        hide(byId("success"));
        hide(byId("respPretty"));
        hide(byId("respWrap"));
        enableForm(false);

        const data = await fetchChoices();

        const submitters = Array.isArray(data.submitters) ? data.submitters.map(s => ({ label:String(s.label||"").trim(), value:String(s.value||"").trim() })) : [];
        const clients = Array.isArray(data.clients) ? data.clients.map(c => ({
          label: String(c.label || c["Matching True Name"] || "").trim(),
          value: String(c.value || c.listId || c["List ID"] || "").trim(),
          folderId: String(c.folderId || c["Folder ID"] || "").trim(),
          ticketId: String(c.ticketId || c["Ticket ID"] || "").trim(),
          url: String(c.url || c.URL || c["URL"] || c.website || c.Website || c.link || c.Link || "").trim()
        })) : [];
        const templates = Array.isArray(data.templates) ? data.templates.map(t => ({
          label: String(t.label || t.name || t["Matched Template Name"] || "").trim(),
          value: String(t.value || t.id || t["ID"] || "").trim(),
          data:  String(t.data  || t["Data"] || "").trim(),
          due:   String(t.due   || t.dueDates || t["Due Dates"] || t["Due Date"] || "").trim()
        })) : [];

        const finalSubmitters = dedupeBy(submitters, x => x.value);
        const finalClients    = dedupeBy(clients,    x => x.value);
        const finalTemplates  = dedupeBy(templates,  x => x.value);

        fillSubmitter(finalSubmitters);
        fillClient(finalClients);
        fillTemplates(finalTemplates);

        const ok = finalSubmitters.length && finalClients.length && finalTemplates.length;
        enableForm(!!ok);
        setStatus(ok ? "All data is added." : "Fetched, but no rows found. Add rows in the sheet and try again.");

        byId("client").addEventListener("change", updateClientWebsiteFromSelect);
        byId("template").addEventListener("change", handleTemplateChange);

        setClientWebsite("");
        byId("dueDate").value = "";
      }catch(e){
        console.error(e);
        setStatus("Couldn't fetch new data.\n" + String(e.message || e), true);
        // Show diagnostic for anyone
        const raw = byId("respRaw");
        raw.textContent = String(e.stack || e.message || e);
        show(byId("respWrap"));
      }
    }

    // ---------- TEMPLATE -> DESCRIPTION + DUE ----------
    function handleTemplateChange(){
      const raw = byId("template").value;
      if(!raw){ editor.innerHTML = ""; byId("dueDate").value = ""; return; }
      try{
        const t = JSON.parse(raw); // { id, name, data, due }
        const isHtml = /<\/?[a-z][\s\S]*>/i.test(t.data || "");
        const htmlRaw = isHtml ? t.data : (t.data || "").split("\n").map(line => `<p>${escapeHtml(line)}</p>`).join("");
        editor.innerHTML = sanitizeHtml(htmlRaw);
        setAutoDueDate(t.due || "");
      }catch(_){
        editor.innerHTML = "";
        byId("dueDate").value = "";
      }
    }

   // ---------- SUBMIT ----------
async function submitForm(e){
  e.preventDefault();
  hide(byId("success"));
  hide(byId("respPretty"));
  hide(byId("respWrap"));

  const rawSubmitter = byId("submitter").value;
  const rawClient    = byId("client").value;
  const rawTemplate  = byId("template").value;
  const team         = byId("team").value;
  if(!rawSubmitter || !rawClient || !rawTemplate || !team){
    setStatus("Please choose submitter, team, client, and template.", true);
    return;
  }

  const submitter = JSON.parse(rawSubmitter);
  const client    = JSON.parse(rawClient);
  const template  = JSON.parse(rawTemplate);

  // Normalize + sanitize editor HTML so ClickUp gets exactly what you typed
  // === Build 3 parallel versions of the description ===
// 1) Raw HTML as typed (max fidelity)
const htmlRaw = editor.innerHTML || "";

// 2) Safe HTML (lightly sanitized, but keep structure)
const htmlSafe = sanitizeHtml(htmlRaw);

// 3) Plain text and Markdown fallbacks
const textPlain = editor.innerText || editor.textContent || "";
const markdown  = htmlSafe
  .replace(/<\s*h[1-6]\s*>/gi, '\n\n**')
  .replace(/<\s*\/\s*h[1-6]\s*>/gi, '**\n\n')
  .replace(/<\s*li\s*>/gi, '\n- ')
  .replace(/<\s*\/\s*li\s*>/gi, '')
  .replace(/<\s*br\s*\/?>/gi, '\n')
  .replace(/<\/p>/gi, '\n\n')
  .replace(/<[^>]+>/g, '')
  .trim();

// Put one into the hidden <textarea> (use the safe HTML)
byId("description").value = htmlSafe;

// Optional: show what we're about to send (helps debugging)
byId("respRaw").textContent =
  `HTML length: ${htmlSafe.length}\n` +
  `MD length:   ${markdown.length}\n` +
  `TXT length:  ${textPlain.length}\n\n` +
  `HTML preview:\n${htmlSafe}\n`;
show(byId("respWrap"));

  const dueDateTime = byId("dueDate").value || "";

  // (Optional) show exactly what we are sending so you can verify both paragraphs exist

  setStatus("Submitting ticket…");
  try {
    const r = await fetch(TICKET_WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        submitterId: submitter.id,
        submitterName: submitter.name,
        team,
        clientName: client.name,
        clientListId: client.listId,
        clientFolderId: client.folderId,
        clientTicketTemplateId: client.ticketId,
        clientUrl: client.url || "",
        templateId: template.id,
        templateName: template.name,
        dueDateTime,
        // ✅ Send ONE canonical description field (HTML only)
        descriptionHtml: htmlSafe,     // preferred cleaned HTML
        descriptionHtmlRaw: htmlRaw,   // exact keystrokes from editor
        descriptionMarkdown: markdown, // markdown fallback
        descriptionText: textPlain,    // plain text fallback
        attachments: attachments.map(a => ({
          filename: a.name, type: a.type, size: a.size, dataUrl: a.dataUrl
        }))
      })
    });

    const body = await r.text();
    setStatus("");

    // Show server response to the user
    byId("respRaw").textContent = `HTTP ${r.status}\n\n${body}`;
    show(byId("respWrap"));
    renderPrettyResponse(body, r.status);

    if (r.ok) {
      try {
        const obj = JSON.parse(body);
        setSuccess(obj);
      } catch {
        setSuccess(body || "Task created successfully.");
      }
    } else {
      setStatus(`There was a problem. HTTP ${r.status}`, true);
    }
  } catch (err) {
    console.error(err);
    setStatus("Network error while submitting ticket.\n" + String(err), true);
    byId("respRaw").textContent = String(err.stack || err);
    show(byId("respWrap"));
  }
}

    // ---------- GALLERY ----------
    function openAttachmentGallery(startIndex=0){
      const viewer = byId("imgViewer");
      const grid   = byId("imgGridModal");
      viewer.innerHTML = "";
      grid.innerHTML = "";
      if(attachments.length === 0){
        viewer.innerHTML = "<div class='muted'>No images in attachments.</div>";
      }else{
        const big = document.createElement("img");
        big.src = attachments[Math.max(0, Math.min(startIndex, attachments.length-1))].dataUrl;
        viewer.appendChild(big);
        attachments.forEach((a, idx) => {
          const card = document.createElement("div");
          card.className = "img-card";
          const thumb = document.createElement("img");
          thumb.src = a.dataUrl;
          thumb.addEventListener("click", () => { big.src = a.dataUrl; });
          card.appendChild(thumb);
          grid.appendChild(card);
        });
      }
      const modal = byId("imgModal");
      modal.style.display = "flex";
      modal.setAttribute("aria-hidden","false");
    }
    function closeImageGallery(){
      const modal = byId("imgModal");
      modal.style.display = "none";
      modal.setAttribute("aria-hidden","true");
    }

    // ---------- WIRE UP ----------
    document.addEventListener("DOMContentLoaded", () => {
      enhanceSelect(byId("team"));
      enableForm(false);
      byId("btnFetch").addEventListener("click", handleFetchNew);
      byId("form").addEventListener("submit", submitForm);
      byId("btnViewAttachments").addEventListener("click", () => openAttachmentGallery(0));
      byId("btnCloseModal").addEventListener("click", closeImageGallery);
      byId("imgModal").addEventListener("click", (e) => { if(e.target === byId("imgModal")) closeImageGallery(); });
    });
  </script>
</body>
</html>
